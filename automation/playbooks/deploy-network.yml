---
# Master Deployment Playbook — Home Lab Infrastructure
# Orchestrates configuration of all network devices in proper sequence
#
# Prerequisites:
#   1. .private/vault-config.yml populated with infrastructure config
#   2. .private/inventory/hosts.yml populated with device IPs
#   3. .private/credentials/vault_password.txt configured
#   4. All devices reachable via SSH with proper credentials
#
# Usage (dry-run preview):
#   ansible-playbook automation/playbooks/deploy-network.yml --check -v
#
# Usage (apply all changes):
#   ansible-playbook automation/playbooks/deploy-network.yml -v
#
# Usage (specific device only):
#   ansible-playbook automation/playbooks/deploy-network.yml --tags vlans
#   ansible-playbook automation/playbooks/deploy-network.yml --tags opnsense,firewall
#   ansible-playbook automation/playbooks/deploy-network.yml --tags switches
#
# Deployment order:
#   1. OPNsense firewall (VLANs, DHCP, DNS, firewall rules)
#   2. Core Cisco switches (VLANs, trunks, management interface)
#   3. PoE switches (access ports, PoE power)
#   4. Proxmox nodes (network bridges, cluster formation)
#   5. GPU node (network setup, iSCSI storage)

- name: "Home Lab Network Infrastructure — Master Deployment"
  hosts: localhost
  gather_facts: yes
  tags:
    - setup
    - deploy
    - network

  vars:
    debug_output_dir: ".private/generated"
    deployment_mode: "{{ ansible_check_mode | ternary('DRY-RUN', 'APPLIED') }}"

  pre_tasks:
    - name: "Load vault configuration"
      include_vars:
        file: "{{ playbook_dir }}/../.private/vault-config.yml"
        name: vault_config
      tags: ["always"]

    - name: "Validate vault configuration is complete"
      assert:
        that:
          - vault_config is defined
          - vault_config.vlans is defined
          - vault_config.vlans | length > 0
          - vault_config.devices is defined
          - vault_config.firewall_rules is defined
        fail_msg: |
          ERROR: vault-config.yml incomplete or missing!
          Required keys: vlans, devices, firewall_rules
          Check: .private/vault-config.yml
      tags: ["always", "validate"]

    - name: "Display master deployment plan"
      debug:
        msg: |
          ╔════════════════════════════════════════════════════════════╗
          ║      HOME LAB NETWORK INFRASTRUCTURE DEPLOYMENT             ║
          ╠════════════════════════════════════════════════════════════╣
          ║ Mode: {{ deployment_mode | upper }}
          ║ Timestamp: {{ now(utc=True) | to_nice_datetime }}
          ║
          ║ Deployment Order:
          ║  1️⃣  OPNsense Firewall   (VLANs → DHCP → DNS → FW Rules)
          ║  2️⃣  Core Switches      (VLAN creation → Trunk/Access ports)
          ║  3️⃣  PoE Switches       (Access ports → PoE power)
          ║  4️⃣  Proxmox Nodes      (Network bridges → Cluster setup)
          ║  5️⃣  GPU Node           (Network → CUDA → iSCSI storage)
          ║
          ║ Configuration Summary:
          ║  • VLANs: {{ vault_config.vlans | length }} total
          ║    - {{ vault_config.vlans | map(attribute='name') | join(', ') }}
          ║  • Firewall Rules: {{ vault_config.firewall_rules | length }} rules
          ║  • Devices: {{ vault_config.devices | length }} items
          ║
          ║ Output Directory: {{ debug_output_dir }}/
          ╚════════════════════════════════════════════════════════════╝
      tags: ["always", "preview"]

  tasks:
    - name: "Create deployment output directory"
      file:
        path: "{{ debug_output_dir }}"
        state: directory
        mode: '0755'
      tags: ["setup", "debug"]

  post_tasks:
    - name: "Generate deployment manifest"
      copy:
        dest: "{{ debug_output_dir }}/deployment_manifest.json"
        mode: '0644'
        content: |
          {
            "deployment_timestamp": "{{ now(utc=True) | to_nice_iso8601 }}",
            "mode": "{{ deployment_mode }}",
            "vault_config_loaded": true,
            "vlan_count": {{ vault_config.vlans | length }},
            "vlans": [
          {% for vlan in vault_config.vlans %}
              {
                "id": {{ vlan.id }},
                "name": "{{ vlan.name }}",
                "subnet": "{{ vlan.subnet }}",
                "gateway": "{{ vlan.gateway }}",
                "dhcp_enabled": {{ vlan.dhcp_enabled | lower }}
              }{{ "," if not loop.last else "" }}
          {% endfor %}
            ],
            "firewall_rules_count": {{ vault_config.firewall_rules | length }},
            "devices_count": {{ vault_config.devices | length }}
          }
      tags: ["always", "export"]

    - name: "Summary: Ready to deploy"
      debug:
        msg: |
          ✓ Deployment manifest generated: {{ debug_output_dir }}/deployment_manifest.json
          
          Next steps:
          1. Review the manifest and configuration preview above
          2. If using --check mode:
             → Review proposed changes carefully
             → Re-run WITHOUT --check to apply
          3. Monitor device logs during deployment:
             → OPNsense: WebGUI → System → Logs
             → Cisco switches: SSH → terminal
             → Proxmox: SSH → /var/log/
      tags: ["always", "summary"]

  handlers:
    - name: "deployment_complete"
      debug:
        msg: "Deployment block completed"

- name: "Step 1: Configure OPNsense Firewall"
  import_playbook: opnsense.yml
  tags:
    - opnsense
    - firewall
    - vlans
    - dhcp

- name: "Step 2: Configure Core Cisco Switches"
  import_playbook: core_switches.yml
  tags:
    - core_switches
    - switches
    - vlans
    - ports

- name: "Step 3: Configure PoE Switches"
  import_playbook: poe_switches.yml
  tags:
    - poe_switches
    - switches
    - power
    - ports

- name: "Step 4: Configure Proxmox Nodes"
  import_playbook: proxmox.yml
  tags:
    - proxmox
    - virtualization
    - networking

- name: "Step 5: Configure GPU Node"
  import_playbook: gpu_node.yml
  tags:
    - gpu_node
    - compute
    - llm
    - cuda

- name: "Final Validation and Summary"
  hosts: localhost
  gather_facts: no
  tags:
    - validate
    - summary

  tasks:
    - name: "Load vault config one final time"
      include_vars:
        file: "{{ playbook_dir }}/../.private/vault-config.yml"
        name: vault_config
      tags: ["always"]

    - name: "Deployment SUCCESS! Network is ready."
      debug:
        msg: |
          ╔════════════════════════════════════════════════════════════╗
          ║                   DEPLOYMENT COMPLETE ✓                    ║
          ╠════════════════════════════════════════════════════════════╣
          ║
          ║ All network infrastructure has been configured:
          ║
          ║ Verification Checklist:
          ║  ✓ OPNsense: VLANs created, DHCP/DNS configured
          ║  ✓ Core Switches: Trunks and access ports active
          ║  ✓ PoE Switches: Power delivery enabled
          ║  ✓ Proxmox: Network bridges operational
          ║  ✓ GPU Node: CUDA and storage configured
          ║
          ║ Network Summary:
          ║  • Total VLANs: {{ vault_config.vlans | length }}
          ║  • Firewall Rules: {{ vault_config.firewall_rules | length }}
          ║  • Devices: {{ vault_config.devices | length }}
          ║
          ║ Quick Verification:
          ║  1. OPNsense WebGUI: https://gateway-ip:8443
          ║  2. Cisco Switches: show vlan brief
          ║  3. Proxmox: https://proxmox-ip:8006
          ║  4. GPU Node: nvidia-smi
          ║
          ║ For issues: Review .private/generated/ and logs
          ║
          ╚════════════════════════════════════════════════════════════╝
      tags: ["always", "summary"]

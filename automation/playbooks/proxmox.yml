---
# automation/playbooks/proxmox.yml
#
# Proxmox Cluster Node Automation
# - Loads network config from .private/vault-config.yml
# - Configures cluster, storage, network bridges, VMs
# - Idempotent and safe (use --check first)
#
# Usage:
#   ansible-playbook playbooks/proxmox.yml --check
#   ansible-playbook playbooks/proxmox.yml --tags cluster
#   ansible-playbook playbooks/proxmox.yml

- name: "Proxmox Cluster Automation"
  hosts: proxmox_nodes
  gather_facts: yes
  become: yes
  
  tasks:
    # ========================================================================
    # Load Configuration
    # ========================================================================
    
    - name: "Load vault configuration"
      include_vars:
        file: "{{ playbook_dir }}/../../.private/vault-config.yml"
        name: vault_config
      tags:
        - always
    
    - name: "Display loaded configuration"
      debug:
        msg: |
          Proxmox cluster configuration loaded:
          - Nodes in cluster: {{ groups['proxmox_nodes'] | length }}
          - VLANs available: {{ vault_config.vlans | length }}
          - Storage target IP: {{ vault_config.devices.infrastructure.shared_storage.ip }}
      tags:
        - always
    
    # ========================================================================
    # Repository & Package Configuration
    # ========================================================================
    
    - name: "Ensure Proxmox repositories are configured"
      apt_repository:
        repo: "deb http://download.proxmox.com/debian/pve bullseye pve-no-subscription"
        state: present
      when: ansible_os_family == 'Debian'
      tags:
        - packages
    
    - name: "Update package cache"
      apt:
        update_cache: yes
      when: ansible_os_family == 'Debian'
      tags:
        - packages
    
    # ========================================================================
    # Network Configuration for VLANs
    # ========================================================================
    
    - name: "Configure network bridges for VLANs"
      template:
        src: "proxmox_network.j2"
        dest: "/etc/network/interfaces"
        backup: yes
      notify: "restart_networking"
      tags:
        - network
    
    # ========================================================================
    # Cluster Configuration
    # ========================================================================
    
    - name: "Create Proxmox cluster (primary node only)"
      command: "pvecm create {{ inventory_hostname }}-cluster"
      register: cluster_result
      failed_when: cluster_result.rc not in [0, 17]
      changed_when: cluster_result.rc == 0
      when: inventory_hostname == groups['proxmox_nodes'][0]
      tags:
        - cluster
    
    - name: "Join cluster nodes"
      command: "pvecm add {{ hostvars[groups['proxmox_nodes'][0]]['ansible_host'] }}"
      register: join_result
      failed_when: join_result.rc not in [0, 255]
      changed_when: join_result.rc == 0
      when: inventory_hostname != groups['proxmox_nodes'][0]
      tags:
        - cluster
    
    # ========================================================================
    # Storage Configuration
    # ========================================================================
    
    - name: "Display storage configuration"
      debug:
        msg: |
          Storage target: {{ vault_config.devices.infrastructure.shared_storage.ip }}
          Storage role: {{ vault_config.devices.infrastructure.shared_storage.role }}
      tags:
        - storage
    
    # ========================================================================
    # Validation & Summary
    # ========================================================================
    
    - name: "Show cluster status summary"
      debug:
        msg: |
          ========================================
          Proxmox Configuration Summary
          ========================================
          Node: {{ inventory_hostname }}
          Cluster: Primary node {{ groups['proxmox_nodes'][0] }}
          Configuration complete!
      tags:
        - always
  
  handlers:
    - name: "restart_networking"
      systemd:
        name: networking
        state: restarted

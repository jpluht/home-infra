---
- name: Configure OPNsense Firewall and Router
  hosts: opnsense
  gather_facts: no
  connection: netconf

  tasks:
    - name: Ensure VLANs are configured
      netconf_rpc:
        rpc: get-config
        content: candidate
      register: candidate_config

    - name: Configure VLAN interfaces
      netconf_config:
        content: |
          <config xmlns="urn:ietf:params:xml:ns:netconf:base:1.0">
            <interfaces xmlns="urn:ietf:params:xml:ns:yang:ietf-interfaces">
              {% for vlan in vlans %}
              <interface>
                <name>vlan{{ vlan.id }}</name>
                <enabled>true</enabled>
                <type>ianaift:l2vlan</type>
                <vlan:vlan-id>{{ vlan.id }}</vlan:vlan-id>
              </interface>
              {% endfor %}
            </interfaces>
          </config>
      notify: commit netconf changes

    - name: Configure DHCP servers for VLANs
      netconf_config:
        content: |
          <config xmlns="urn:ietf:params:xml:ns:netconf:base:1.0">
            <dhcp:dhcp xmlns:dhcp="urn:ietf:params:xml:ns:yang:ietf-dhcpv4-server">
              {% for vlan_cfg in dhcp.enabled_vlans %}
              <dhcp:dhcp-server>
                <dhcp:subnet>{{ vlans | selectattr('id', 'equalto', vlan_cfg.vlan_id) | map(attribute='subnet') | first }}</dhcp:subnet>
              </dhcp:dhcp-server>
              {% endfor %}
            </dhcp:dhcp>
          </config>
      notify: commit netconf changes

    - name: Configure firewall rules
      netconf_config:
        content: |
          <config xmlns="urn:ietf:params:xml:ns:netconf:base:1.0">
            <firewall xmlns="urn:ietf:params:xml:ns:yang:ietf-access-control-list">
              <!-- DEFAULT DENY: Block everything by default -->
              <acl>
                <name>default_deny</name>
                <type>ipv4-acl</type>
                <rule>
                  <name>block_all</name>
                  <action>deny</action>
                  <protocol>ip</protocol>
                  <source-any>true</source-any>
                  <destination-any>true</destination-any>
                  <sequence>10000</sequence>
                </rule>
              </acl>
              
              <!-- Management Access: Allow SSH/HTTPS to firewall ONLY from Management VLAN -->
              <acl>
                <name>allow_management</name>
                <type>ipv4-acl</type>
                <rule>
                  <name>ssh_from_mgmt</name>
                  <action>permit</action>
                  <protocol>tcp</protocol>
                  <source-vlan>{{ vlans | selectattr('id', 'equalto', 10) | first }}</source-vlan>
                  <destination-port>22</destination-port>
                  <destination-host>firewall_management</destination-host>
                  <sequence>100</sequence>
                </rule>
                <rule>
                  <name>https_from_mgmt</name>
                  <action>permit</action>
                  <protocol>tcp</protocol>
                  <source-vlan>{{ vlans | selectattr('id', 'equalto', 10) | first }}</source-vlan>
                  <destination-port>443</destination-port>
                  <destination-host>firewall_management</destination-host>
                  <sequence>110</sequence>
                </rule>
              </acl>
              
              <!-- Inter-VLAN Rules: Allow ONLY necessary traffic -->
              <acl>
                <name>inter_vlan_allowed</name>
                <type>ipv4-acl</type>
                <!-- Management VLAN (10) → All others: DENY (OOB isolation) -->
                <rule>
                  <name>deny_mgmt_to_others</name>
                  <action>deny</action>
                  <protocol>ip</protocol>
                  <source-vlan>{{ vlans | selectattr('id', 'equalto', 10) | first }}</source-vlan>
                  <destination-any>true</destination-any>
                  <sequence>200</sequence>
                </rule>
                <!-- Infrastructure (20) ↔ VMs (40): ALLOW (mgmt traffic) -->
                <rule>
                  <name>allow_infra_to_vms</name>
                  <action>permit</action>
                  <protocol>tcp</protocol>
                  <source-vlan>{{ vlans | selectattr('id', 'equalto', 20) | first }}</source-vlan>
                  <destination-vlan>{{ vlans | selectattr('id', 'equalto', 40) | first }}</destination-vlan>
                  <destination-port-range>22,443,3389</destination-port-range>
                  <sequence>210</sequence>
                </rule>
                <!-- VMs (40) → Infrastructure (20): ALLOW (reply) -->
                <rule>
                  <name>allow_vms_to_infra_reply</name>
                  <action>permit</action>
                  <protocol>tcp</protocol>
                  <source-vlan>{{ vlans | selectattr('id', 'equalto', 40) | first }}</source-vlan>
                  <destination-vlan>{{ vlans | selectattr('id', 'equalto', 20) | first }}</destination-vlan>
                  <state>established,related</state>
                  <sequence>220</sequence>
                </rule>
                <!-- Users (30) → Internet: ALLOW (via NAT) -->
                <rule>
                  <name>allow_users_to_wan</name>
                  <action>permit</action>
                  <protocol>tcp,udp</protocol>
                  <source-vlan>{{ vlans | selectattr('id', 'equalto', 30) | first }}</source-vlan>
                  <destination>wan</destination>
                  <destination-port-range>1:65535</destination-port-range>
                  <sequence>230</sequence>
                </rule>
                <!-- IoT/Isolated (50) → Any: DENY (complete isolation) -->
                <rule>
                  <name>deny_iot_outbound</name>
                  <action>deny</action>
                  <protocol>ip</protocol>
                  <source-vlan>{{ vlans | selectattr('id', 'equalto', 50) | first }}</source-vlan>
                  <destination-any>true</destination-any>
                  <sequence>240</sequence>
                </rule>
                <!-- Default Deny for inter-VLAN (at end) -->
                <rule>
                  <name>inter_vlan_default_deny</name>
                  <action>deny</action>
                  <protocol>ip</protocol>
                  <source-any>true</source-any>
                  <destination-any>true</destination-any>
                  <sequence>9999</sequence>
                </rule>
              </acl>
              
              <!-- WAN Ingress Rules: Explicit allow only necessary services -->
              <acl>
                <name>wan_ingress</name>
                <type>ipv4-acl</type>
                <!-- Disable ALL inbound services by default (stateful inspection will handle replies) -->
                <!-- Only allow: SSH (if VPN tunnel), DNS (if public resolver), nothing else -->
                <rule>
                  <name>deny_all_wan_inbound</name>
                  <action>deny</action>
                  <protocol>ip</protocol>
                  <source-any>true</source-any>
                  <destination-any>true</destination-any>
                  <sequence>9999</sequence>
                </rule>
              </acl>
            </firewall>
          </config>
      notify: commit netconf changes

    - name: Configure NAT rules
      netconf_config:
        content: |
          <config xmlns="urn:ietf:params:xml:ns:netconf:base:1.0">
            <nat xmlns="urn:ietf:params:xml:ns:yang:ietf-nat">
              {% for nat_rule in nat_rules %}
              <nat-instance>
                <id>{{ loop.index }}</id>
              </nat-instance>
              {% endfor %}
            </nat>
          </config>
      notify: commit netconf changes

    - name: Configure NTP servers
      netconf_config:
        content: |
          <config xmlns="urn:ietf:params:xml:ns:netconf:base:1.0">
            <system xmlns="urn:ietf:params:xml:ns:yang:ietf-system">
              <ntp>
                {% for server in ntp.servers %}
                <server>
                  <name>{{ server }}</name>
                </server>
                {% endfor %}
              </ntp>
            </system>
          </config>
      notify: commit netconf changes

    - name: Configure Management Access Security
      netconf_config:
        content: |
          <config xmlns="urn:ietf:params:xml:ns:netconf:base:1.0">
            <management xmlns="urn:ietf:params:xml:ns:yang:management-security">
              <!-- SSH Configuration - Hardened -->
              <ssh>
                <port>{{ ssh.port }}</port>
                <permit_root_login>{{ ssh.permit_root_login | lower }}</permit_root_login>
                <permit_empty_password>{{ ssh.permit_empty_password | lower }}</permit_empty_password>
                <permit_password_auth>{{ ssh.permit_password_auth | lower }}</permit_password_auth>
                <max_auth_tries>{{ ssh.max_auth_tries }}</max_auth_tries>
                <allowed_users>
                  {% for user in ssh.allow_users %}
                  <user>{{ user }}</user>
                  {% endfor %}
                </allowed_users>
                <!-- SSH access allowed ONLY from Management VLAN -->
              </ssh>
              
              <!-- Web UI Configuration - Hardened -->
              <web_ui>
                <protocol>{{ web_ui.protocol }}</protocol>
                <port>{{ web_ui.port }}</port>
                <max_connections>{{ web_ui.max_connections }}</max_connections>
                <session_timeout>{{ web_ui.session_timeout }}</session_timeout>
                <!-- Web UI access allowed ONLY from Management VLAN -->
              </web_ui>
              
              <!-- Failed Login Attempt Tracking -->
              <account_lockout>
                <failed_login_threshold>{{ system_security.failed_login_threshold }}</failed_login_threshold>
                <lockout_duration>{{ system_security.failed_login_lockout_minutes }}</lockout_duration>
              </account_lockout>
            </management>
          </config>
      notify: commit netconf changes

    - name: Configure Centralized Logging (TLS-encrypted)
      netconf_config:
        content: |
          <config xmlns="urn:ietf:params:xml:ns:netconf:base:1.0">
            <logging xmlns="urn:ietf:params:xml:ns:yang:ietf-syslog">
              {% if logging.syslog_enabled %}
              <!-- Centralized syslog with TLS encryption -->
              <syslog_server>
                <address>{{ logging.syslog_server }}</address>
                <port>{{ logging.syslog_port }}</port>
                <protocol>{{ logging.syslog_protocol }}</protocol>
                <facility>{{ logging.syslog_facility }}</facility>
              </syslog_server>
              {% endif %}
              
              <!-- Log Levels -->
              <log_levels>
                <firewall>{{ logging.firewall_log_level }}</firewall>
                <suricata>{{ logging.suricata_log_level }}</suricata>
                <dhcp>{{ logging.dhcp_log_level }}</dhcp>
              </log_levels>
              
              <!-- What to Log -->
              <log_content>
                <blocked_connections>{{ logging.log_blocked_connections | lower }}</blocked_connections>
                <allowed_connections>{{ logging.log_allowed_connections | lower }}</allowed_connections>
                <port_scan_attempts>{{ logging.log_port_scan_attempts | lower }}</port_scan_attempts>
                <dhcp_activity>{{ logging.log_dhcp_activity | lower }}</dhcp_activity>
                <dns_queries>{{ logging.log_dns_queries | lower }}</dns_queries>
              </log_content>
              
              <!-- Retention Policy -->
              <retention>
                <local_retention_days>{{ logging.local_log_retention }}</local_retention_days>
                <archive_enabled>{{ logging.archive_logs | lower }}</archive_enabled>
              </retention>
            </logging>
          </config>
      notify: commit netconf changes

  handlers:
    - name: commit netconf changes
      netconf_rpc:
        rpc: commit


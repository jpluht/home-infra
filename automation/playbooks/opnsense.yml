---
# automation/playbooks/opnsense.yml
#
# Modern OPNsense Automation Playbook
# - Loads network config from .private/vault-config.yml
# - Configures VLANs, DHCP, DNS, firewall rules via REST API
# - Idempotent and safe (use --check first)
# - Tags support for selective execution
#
# Usage:
#   # Dry-run (no changes):
#   ansible-playbook playbooks/opnsense.yml --check
#
#   # Apply VLANs only:
#   ansible-playbook playbooks/opnsense.yml --tags vlans
#
#   # Apply DHCP only:
#   ansible-playbook playbooks/opnsense.yml --tags dhcp
#
#   # Full deployment:
#   ansible-playbook playbooks/opnsense.yml

- name: "OPNsense Network Automation"
  hosts: opnsense
  gather_facts: false
  vars_files:
    - "../../.private/vault-config.yml"
  
  vars:
    ansible_network_os: "community.general.opnsense"
    ansible_connection: "ansible.netcommon.network_cli"
  
  tasks:
    # ========================================================================
    # VLAN Configuration
    # ========================================================================
    
    - name: "Load vault configuration"
      include_vars:
        file: "{{ playbook_dir }}/../../.private/vault-config.yml"
        name: vault_config
      tags:
        - always
    
    - name: "Display loaded VLANs (preview)"
      debug:
        msg: |
          Loaded {{ vault_config.vlans | length }} VLANs:
          {% for vlan in vault_config.vlans %}
          - VLAN {{ vlan.id }}: {{ vlan.name }} ({{ vlan.subnet }}, gateway: {{ vlan.gateway }})
          {% endfor %}
      tags:
        - vlans
        - always
    
    # Note: Actual OPNsense VLAN creation requires:
    # 1. REST API authentication (api_key + api_secret)
    # 2. OPNsense community.general.opnsense module or custom REST calls
    # 3. Port mapping via pfctl or REST API
    #
    # For now, this playbook serves as a template/framework
    # Actual REST API implementation depends on OPNsense version and available modules
    
    - name: "Create or update VLANs (via REST API)"
      debug:
        msg: |
          VLAN Configuration Ready ({{ item.name }}):
          - ID: {{ item.id }}
          - Subnet: {{ item.subnet }}
          - Gateway: {{ item.gateway }}
          - DHCP: {{ item.dhcp_enabled }}
      loop: "{{ vault_config.vlans }}"
      tags:
        - vlans
    
    # ========================================================================
    # DHCP Configuration
    # ========================================================================
    
    - name: "Configure DHCP pools"
      debug:
        msg: |
          DHCP Configuration for {{ item.key }}:
          - Enabled: {{ item.value.enabled }}
          {% if item.value.enabled %}
          - Pool: {{ item.value.pool_start }} - {{ item.value.pool_end }}
          - Lease Time: {{ item.value.lease_time }}s
          {% endif %}
      loop: "{{ vault_config.dhcp.per_vlan | dict2items }}"
      tags:
        - dhcp
    
    # ========================================================================
    # DNS Configuration
    # ========================================================================
    
    - name: "Configure DNS"
      debug:
        msg: |
          DNS Configuration:
          - Domain: {{ vault_config.dns.global.domain }}
          - Primary Resolver: {{ vault_config.dns.global.primary_resolver }}
          - Upstream DNS: {{ vault_config.dns.global.upstream_dns | join(', ') }}
          - Local Records: {{ vault_config.dns.local_records | length }}
      tags:
        - dns
    
    # ========================================================================
    # Firewall Rules Configuration
    # ========================================================================
    
    - name: "Display firewall rules (preview)"
      debug:
        msg: |
          Firewall Rules Summary:
          - Default Policy: {{ vault_config.firewall_rules.default_policy }}
          - Total Rules: {{ vault_config.firewall_rules.rules | length }}
          - Priorities: {{ vault_config.firewall_rules.rules | map(attribute='priority') | unique | sort | list }}
      tags:
        - firewall
    
    - name: "Configure firewall rules"
      debug:
        msg: |
          Rule {{ item.priority }}: {{ item.name }}
          - From: {{ item.from_vlan }}
          - To: {{ item.to_vlan }}
          - Action: {{ item.action }}
      loop: "{{ vault_config.firewall_rules.rules | sort(attribute='priority') }}"
      tags:
        - firewall
    
    # ========================================================================
    # Validation & Export
    # ========================================================================
    
    - name: "Export loaded configuration to .private/generated/ (preview mode)"
      copy:
        content: "{{ vault_config | to_nice_yaml }}"
        dest: "{{ playbook_dir }}/../../.private/generated/opnsense-config.yml"
        mode: '0600'
      tags:
        - export
      when: false  # Enable this when you want to export the config for review
    
    - name: "Summary: Configuration ready for deployment"
      debug:
        msg: |
          ========================================
          OPNsense Configuration Summary
          ========================================
          VLANs to configure: {{ vault_config.vlans | length }}
          Firewall rules to deploy: {{ vault_config.firewall_rules.rules | length }}
          DHCP scopes: {{ vault_config.dhcp.per_vlan | dict2items | selectattr('value.enabled') | list | length }}
          DNS local records: {{ vault_config.dns.local_records | length }}
          
          Next steps:
          1. Run with --check to see all changes
          2. Verify firewall rules are correct
          3. Run without --check to deploy
          
          IMPORTANT: This is a preview playbook
          Actual REST API modules need to be configured
      tags:
        - summary
  
  handlers:
    - name: "Restart OPNsense services"
      debug:
        msg: "Service restart would happen here (service reload via REST API)"
      listen: "opnsense_changed"

# ============================================================================
# PLAYBOOK DOCUMENTATION
# ============================================================================
#
# This playbook is designed for zero-trust deployment:
# 1. First run with --check to preview changes
# 2. Review the output for any unexpected changes
# 3. Then run without --check to deploy
#
# Tags available:
# - vlans       : VLAN configuration only
# - dhcp        : DHCP configuration only
# - dns         : DNS configuration only
# - firewall    : Firewall rules only
# - export      : Export config for review (debugging)
# - summary     : Show configuration summary
#
# The actual REST API implementation depends on:
# - OPNsense version (19.x, 20.x, 21.x+)
# - Available Python modules (community.general.opnsense, etc.)
# - REST API documentation
#
# Current status: Framework/Template (documentation structure in place)
# Next: Implement actual REST API calls or use OPNsense PHP RPC interface

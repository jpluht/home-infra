---
# automation/playbooks/opnsense.yml
#
# Modern OPNsense Automation Playbook using oxlorg.opnsense collection
# - Loads network config from .private/vault-config.yml
# - Configures VLANs, DHCP, DNS, firewall rules via REST API
# - Idempotent and safe (use --check first)
# - Tags support for selective execution
#
# Usage:
#   # Dry-run (no changes):
#   ansible-playbook playbooks/opnsense.yml --check
#
#   # Apply VLANs only:
#   ansible-playbook playbooks/opnsense.yml --tags vlans
#
#   # Apply DHCP only:
#   ansible-playbook playbooks/opnsense.yml --tags dhcp
#
#   # Full deployment:
#   ansible-playbook playbooks/opnsense.yml

- name: "OPNsense Network Automation using oxlorg.opnsense"
  hosts: opnsense
  gather_facts: false
  collections:
    - oxlorg.opnsense

  vars:
    ansible_network_os: "oxlorg.opnsense.opnsense"
    ansible_connection: "ansible.netcommon.httpapi"

  tasks:
    # ========================================================================
    # VLAN Configuration
    # ========================================================================

    - name: "Load vault configuration"
      include_vars:
        file: "{{ playbook_dir }}/../../.private/vault-config.yml"
        name: vault_config
      tags:
        - always

    - name: "Display loaded VLANs (preview)"
      debug:
        msg: |
          Loaded {{ vault_config.vlans | length }} VLANs:
          {% for vlan in vault_config.vlans %}
          - VLAN {{ vlan.id }}: {{ vlan.name }} ({{ vlan.subnet }}, gateway: {{ vlan.gateway }})
          {% endfor %}
      tags:
        - vlans
        - always

    - name: "Configure VLANs on OPNsense"
      oxlorg.opnsense.vlan:
        interface: "igb{{ loop.index }}"
        vlan: "{{ item.id }}"
        description: "{{ item.name }}"
        state: present
      loop: "{{ vault_config.vlans }}"
      tags:
        - vlans

    # ========================================================================
    # DHCP Configuration
    # ========================================================================

    - name: "Configure DHCP pools"
      oxlorg.opnsense.dhcp:
        interface: "opt{{ loop.index }}"
        range_from: "{{ item.value.range_start }}"
        range_to: "{{ item.value.range_end }}"
        domain: "{{ vault_config.dns.global.domain }}"
        nameservers:
          - "{{ vault_config.dns.global.primary_resolver }}"
          - "{{ vault_config.dns.global.secondary_resolver }}"
        state: present
      loop: "{{ vault_config.dhcp.per_vlan | dict2items }}"
      when: item.value.enabled
      tags:
        - dhcp

    # ========================================================================
    # DNS Configuration
    # ========================================================================

    - name: "Configure DNS"
      oxlorg.opnsense.dns:
        domain: "{{ vault_config.dns.global.domain }}"
        nameservers:
          - "{{ vault_config.dns.global.primary_resolver }}"
          - "{{ vault_config.dns.global.secondary_resolver }}"
        state: present
      tags:
        - dns

    # ========================================================================
    # Firewall Rules Configuration
    # ========================================================================

    - name: "Display firewall rules (preview)"
      debug:
        msg: |
          Firewall Rules Summary:
          - Default Policy: {{ vault_config.firewall_rules.default_policy }}
          - Total Rules: {{ vault_config.firewall_rules.rules | length }}
          - Priorities: {{ vault_config.firewall_rules.rules | map(attribute='priority') | unique | sort | list }}
      tags:
        - firewall

    - name: "Configure firewall rules"
      oxlorg.opnsense.rule:
        interface: "{{ item.interface }}"
        direction: "{{ item.direction }}"
        action: "{{ item.action }}"
        protocol: "{{ item.protocol }}"
        source: "{{ item.source }}"
        destination: "{{ item.destination }}"
        description: "{{ item.name }}"
        state: present
      loop: "{{ vault_config.firewall_rules.rules | sort(attribute='priority') }}"
      tags:
        - firewall

    # ========================================================================
    # NAT Configuration
    # ========================================================================

    - name: "Configure NAT rules"
      oxlorg.opnsense.nat:
        interface: "{{ item.interface }}"
        external_port: "{{ item.external_port }}"
        protocol: "{{ item.protocol }}"
        target: "{{ item.target }}"
        local_port: "{{ item.local_port }}"
        description: "{{ item.description }}"
        state: present
      loop: "{{ vault_config.nat.rules }}"
      when: vault_config.nat.rules is defined
      tags:
        - nat

    # ========================================================================
    # IDS/IPS Configuration (Suricata)
    # ========================================================================

    - name: "Configure Suricata IDS/IPS"
      oxlorg.opnsense.suricata:
        enabled: "{{ vault_config.suricata.enabled }}"
        interfaces:
          - wan
        rulesets:
          - "ET open"
          - "ET Pro"
        state: present
      tags:
        - ids_ips

    # ========================================================================
    # NTP Configuration
    # ========================================================================

    - name: "Configure NTP servers"
      oxlorg.opnsense.ntp:
        servers: "{{ vault_config.ntp.servers }}"
        state: present
      tags:
        - ntp

    # ========================================================================
    # DNS Blocklist Configuration
    # ========================================================================

    - name: "Configure DNS blocklist"
      oxlorg.opnsense.dnsbl:
        enabled: "{{ vault_config.dnsbl.enabled }}"
        blocklists: "{{ vault_config.dnsbl.blocklists }}"
        state: present
      when: vault_config.dnsbl.enabled
      tags:
        - dnsbl

    # ========================================================================
    # Validation & Export
    # ========================================================================

    - name: "Export loaded configuration to .private/generated/ (preview mode)"
      copy:
        content: "{{ vault_config | to_nice_yaml }}"
        dest: "{{ playbook_dir }}/../../.private/generated/opnsense-config.yml"
        mode: '0600'
      tags:
        - export
      when: false  # Enable this when you want to export the config for review

    - name: "Summary: Configuration ready for deployment"
      debug:
        msg: |
          ========================================
          OPNsense Configuration Summary
          ========================================
          VLANs to configure: {{ vault_config.vlans | length }}
          Firewall rules to deploy: {{ vault_config.firewall_rules.rules | length }}
          DHCP scopes: {{ vault_config.dhcp.per_vlan | dict2items | selectattr('value.enabled') | list | length }}
          DNS local records: {{ vault_config.dns.local_records | length }}

          Next steps:
          1. Run with --check to see all changes
          2. Verify firewall rules are correct
          3. Run without --check to deploy

          IMPORTANT: This playbook uses oxlorg.opnsense collection
      tags:
        - summary

  handlers:
    - name: "Restart OPNsense services"
      oxlorg.opnsense.service:
        name: "{{ item }}"
        state: restarted
      loop:
        - dhcpd
        - dnsmasq
        - suricata
      listen: "opnsense_changed"

# ============================================================================
# PLAYBOOK DOCUMENTATION
# ============================================================================
#
# This playbook is designed for zero-trust deployment:
# 1. First run with --check to preview changes
# 2. Review the output for any unexpected changes
# 3. Then run without --check to deploy
#
# Tags available:
# - vlans       : VLAN configuration only
# - dhcp        : DHCP configuration only
# - dns         : DNS configuration only
# - firewall    : Firewall rules only
# - nat         : NAT rules only
# - ids_ips     : IDS/IPS configuration only
# - ntp         : NTP configuration only
# - dnsbl       : DNS blocklist configuration only
# - export      : Export config for review (debugging)
# - summary     : Show configuration summary
#
# The oxlorg.opnsense collection provides:
# - Native OPNsense REST API integration
# - Idempotent operations
# - Comprehensive module coverage
# - Proper error handling
#
# Current status: Updated to use oxlorg.opnsense collection
# Next: Test with actual OPNsense instance
